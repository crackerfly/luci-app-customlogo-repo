#!/bin/sh /etc/rc.common

START=99
USE_PROCD=1

BACKUP_SUFFIX=".backup"

backup_file() {
    local file=$1
    if [ -f "$file" ] && [ ! -f "${file}${BACKUP_SUFFIX}" ]; then
        cp "$file" "${file}${BACKUP_SUFFIX}"
    fi
}

restore_file() {
    local file=$1
    if [ -f "${file}${BACKUP_SUFFIX}" ]; then
        cp "${file}${BACKUP_SUFFIX}" "$file"
    fi
}

apply_logos() {
    local enable
    local favicon
    local logo

    config_load customlogo
    config_get enable main enable "0"
    config_get favicon main favicon ""
    config_get logo main logo ""

    if [ "$enable" = "1" ]; then
        # 修复权限：确保 Web 服务器有权读取用户上传的文件
        chmod 644 /etc/customlogo/* 2>/dev/null

        # 1. 处理 Favicon
        if [ -n "$favicon" ] && [ -f "$favicon" ]; then
            backup_file "/www/favicon.ico"
            cp "$favicon" "/www/favicon.ico"
            chmod 644 "/www/favicon.ico"
        fi

        # 2. 处理 Logo (暴力覆盖常见主题的所有可能引用的扩展名，防止主题强行读取原生 SVG)
        if [ -n "$logo" ] && [ -f "$logo" ]; then
            # Bootstrap 主题
            if [ -d "/www/luci-static/bootstrap" ]; then
                backup_file "/www/luci-static/bootstrap/logo.png"
                backup_file "/www/luci-static/bootstrap/logo.svg"
                cp "$logo" "/www/luci-static/bootstrap/logo.png" 2>/dev/null
                cp "$logo" "/www/luci-static/bootstrap/logo.svg" 2>/dev/null
                chmod 644 /www/luci-static/bootstrap/logo.* 2>/dev/null
            fi
            # Argon 主题 (包含深色模式)
            if [ -d "/www/luci-static/argon" ]; then
                backup_file "/www/luci-static/argon/img/logo.png"
                backup_file "/www/luci-static/argon/img/logo.svg"
                backup_file "/www/luci-static/argon/img/logo-dark.svg"
                cp "$logo" "/www/luci-static/argon/img/logo.png" 2>/dev/null
                cp "$logo" "/www/luci-static/argon/img/logo.svg" 2>/dev/null
                cp "$logo" "/www/luci-static/argon/img/logo-dark.svg" 2>/dev/null
                chmod 644 /www/luci-static/argon/img/logo* 2>/dev/null
            fi
        fi
    else
        # 禁用时恢复所有原生文件
        restore_file "/www/favicon.ico"
        restore_file "/www/luci-static/bootstrap/logo.png"
        restore_file "/www/luci-static/bootstrap/logo.svg"
        restore_file "/www/luci-static/argon/img/logo.png"
        restore_file "/www/luci-static/argon/img/logo.svg"
        restore_file "/www/luci-static/argon/img/logo-dark.svg"
    fi
}

start_service() {
    mkdir -p /etc/customlogo
    apply_logos
}

service_triggers() {
    procd_add_reload_trigger "customlogo"
}

reload_service() {
    apply_logos
}
