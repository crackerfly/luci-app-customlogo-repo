name: Build OpenWrt 24.10 IPK

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build luci-app-customlogo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          # 新增了 zstd 以支持 OpenWrt 24.10 的新压缩格式
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget zstd

      - name: Download and extract OpenWrt 24.10 SDK
        run: |
          OPENWRT_VERSION="24.10.5" # 你也可以在这里无缝改成 24.10.1 等未来版本
          
          # 自动去官网抓取最新的文件名校验表
          wget "https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/x86/64/sha256sums"
          SDK_FILE=$(grep 'openwrt-sdk' sha256sums | awk '{print $2}' | sed 's/^\*//')
          
          echo "动态匹配到的 SDK 文件: $SDK_FILE"
          
          # 下载并解压 (全面兼容 .zst 或 .xz)
          wget "https://downloads.openwrt.org/releases/${OPENWRT_VERSION}/targets/x86/64/${SDK_FILE}"
          tar -xf "$SDK_FILE"
          
          # 获取解压后的文件夹名并重命名为 openwrt-sdk
          DIR_NAME=$(echo "$SDK_FILE" | sed -e 's/.tar.zst//' -e 's/.tar.xz//')
          mv "$DIR_NAME" openwrt-sdk
          
      - name: Copy source code to SDK
        run: |
          cp -r luci-app-customlogo openwrt-sdk/package/
          
      - name: Update and install feeds
        working-directory: openwrt-sdk
        run: |
          # 替换所有的官方源为 GitHub 镜像源 (彻底覆盖 base, feed, project)
          sed -i 's/git.openwrt.org\/openwrt/github.com\/openwrt/g' feeds.conf.default
          sed -i 's/git.openwrt.org\/feed/github.com\/openwrt/g' feeds.conf.default
          sed -i 's/git.openwrt.org\/project/github.com\/openwrt/g' feeds.conf.default
          
          # 更新并安装
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile the IPK
        working-directory: openwrt-sdk
        run: |
          make defconfig
          make package/luci-app-customlogo/compile V=s

      - name: Prepare Artifact
        run: |
          mkdir -p output_ipk
          find openwrt-sdk/bin/packages/ -name "luci-app-customlogo*.ipk" -exec cp {} output_ipk/ \;

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-customlogo-ipk
          path: output_ipk/*.ipk
